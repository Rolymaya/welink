generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  COMPANY_USER
}

enum SessionStatus {
  CONNECTED
  DISCONNECTED
  QR_READY
  AUTHENTICATED
}

enum SessionType {
  BAILEYS
  CLOUD_API
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  passwordHash  String
  name          String?
  phone         String?
  profilePhoto  String?      @db.LongText
  role          Role         @default(COMPANY_ADMIN)
  resetToken    String?      @unique
  resetTokenExpiry DateTime?
  organization  Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?
  playgroundSessions PlaygroundSession[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@index([role])
  @@index([organizationId])
  @@index([email])
}

model Organization {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  logo          String?  @db.LongText
  sector        String?
  description   String?  @db.Text
  
  businessHours Json?
  
  privacyPolicy    String? @db.Text
  termsOfService   String? @db.Text
  returnPolicy     String? @db.Text
  
  isActive      Boolean  @default(true)
  onboarded     Boolean  @default(false)
  
  plan          String   @default("FREE")
  
  // Subscription limits
  maxAgents     Int      @default(0)
  maxSessions   Int      @default(0)
  maxContacts   Int      @default(0)
  
  users         User[]
  agents        Agent[]
  knowledgeBases KnowledgeBase[]
  contacts      Contact[]
  contactDirectory ContactDirectory[]
  agendas       Agenda[]
  subscriptions Subscription[]
  transactions  Transaction[]
  playgroundAgents   PlaygroundAgent[]
  playgroundSessions PlaygroundSession[]
  products      Product[]
  orders        Order[]
  bankAccounts  BankAccount[]

  // OpenAI Integration
  openaiVectorStoreId String? // ID of the organization's vector store for knowledge base

  // Affiliate Relations
  affiliateProfile AffiliateProfile?
  referral         AffiliateReferral? @relation("ReferredOrganization") // If this org was referred by someone

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AffiliateProfile {
  id             String   @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String   @unique

  referralCode   String   @unique
  walletBalance  Decimal  @db.Decimal(10, 2) @default(0)
  totalEarnings  Decimal  @db.Decimal(10, 2) @default(0)

  bankAccounts   AffiliateBankAccount[]

  referrals      AffiliateReferral[] @relation("ReferrerProfile")
  transactions   AffiliateTransaction[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AffiliateBankAccount {
  id                 String           @id @default(uuid())
  affiliateProfile   AffiliateProfile @relation(fields: [affiliateProfileId], references: [id], onDelete: Cascade)
  affiliateProfileId String

  bankName           String
  accountHolder      String
  accountNumber      String
  iban               String?
  swift              String?

  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model AffiliateReferral {
  id             String   @id @default(uuid())
  
  referrer       AffiliateProfile @relation("ReferrerProfile", fields: [referrerId], references: [id])
  referrerId     String

  referred       Organization @relation("ReferredOrganization", fields: [referredOrgId], references: [id])
  referredOrgId  String   @unique

  status         String   @default("ACTIVE") // ACTIVE, INACTIVE
  commissionCount Int     @default(0)
  totalAmount     Decimal  @default(0) @db.Decimal(10, 2)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AffiliateTransaction {
  id                String   @id @default(uuid())
  affiliateProfile  AffiliateProfile @relation(fields: [affiliateProfileId], references: [id])
  affiliateProfileId String

  type              AffiliateTransactionType
  amount            Decimal @db.Decimal(10, 2)
  status            AffiliateTransactionStatus @default(COMPLETED)
  
  description       String?
  bankSnapshot      Json?    // Snapshot of bank details at usage time

  createdAt         DateTime @default(now())
}

enum AffiliateTransactionType {
  COMMISSION_EARNED
  WITHDRAWAL_REQUEST
  WITHDRAWAL_COMPLETED
  WITHDRAWAL_REJECTED
}

enum AffiliateTransactionStatus {
  PENDING
  APPROVED
  COMPLETED
  REJECTED
}

model Package {
  id                  String         @id @default(uuid())
  name                String
  description         String         @db.Text
  price               Decimal        @db.Decimal(10, 2)
  durationDays        Int
  maxAgents           Int
  maxSessions         Int
  maxContacts         Int
  allowAudioResponse  Boolean        @default(false)
  allowScheduling     Boolean        @default(true)
  isActive            Boolean        @default(true)
  subscriptions       Subscription[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

model Subscription {
  id               String             @id @default(uuid())
  organization     Organization       @relation(fields: [organizationId], references: [id])
  organizationId   String
  package          Package            @relation(fields: [packageId], references: [id])
  packageId        String
  bankAccount      BankAccount?       @relation(fields: [bankAccountId], references: [id])
  bankAccountId    String?
  startDate        DateTime
  endDate          DateTime
  status           SubscriptionStatus @default(PENDING_PAYMENT)
  paymentProofUrl  String?            @db.Text
  transactions     Transaction[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  
  @@index([organizationId])
  @@index([status])
  @@index([endDate])
  @@index([packageId])
}

model BankAccount {
  id            String         @id @default(uuid())
  bankName      String
  accountHolder String
  iban          String
  swift         String?
  isActive      Boolean        @default(true)
  subscriptions Subscription[]
  
  organization  Organization?  @relation(fields: [organizationId], references: [id])
  organizationId String?

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@index([organizationId])
}

model Transaction {
  id               String            @id @default(uuid())
  organization     Organization      @relation(fields: [organizationId], references: [id])
  organizationId   String
  subscription     Subscription      @relation(fields: [subscriptionId], references: [id])
  subscriptionId   String
  amount           Decimal           @db.Decimal(10, 2)
  status           TransactionStatus @default(PENDING)
  type             TransactionType
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Agent {
  id            String       @id @default(uuid())
  name          String
  prompt        String       @db.Text
  organization  Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  sessions      Session[]
  isActive      Boolean      @default(true)
  
  // OpenAI Integration
  openaiAssistantId String?   // ID of the OpenAI Assistant (DNA/Personality)
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Session {
  id            String        @id @default(uuid())
  agent         Agent         @relation(fields: [agentId], references: [id])
  agentId       String
  status        SessionStatus @default(DISCONNECTED)
  type          SessionType   @default(BAILEYS)
  qrCode        String?       @db.LongText
  messages      Message[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Contact {
  id            String       @id @default(uuid())
  phone         String
  name          String?
  organization  Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  messages      Message[]
  agendas       Agenda[]
  orders        Order[]
  tags          String   @default("")
  
  // OpenAI Integration
  openaiConversationId String? // ID of the OpenAI Thread (Memory)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([organizationId, phone])
}

// Contact Directory - Base de Contactos (shown in /contacts page)
// This table is separate from Contact to allow subscription limit enforcement
// while keeping message processing functional
model ContactDirectory {
  id            String       @id @default(uuid())
  phone         String
  name          String?
  organization  Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  tags          String       @default("")
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([organizationId, phone])
  @@index([organizationId])
}


model Message {
  id            String      @id @default(uuid())
  content       String      @db.Text
  role          MessageRole
  session       Session?    @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  sessionId     String?
  contact       Contact?    @relation(fields: [contactId], references: [id])
  contactId     String?
  createdAt     DateTime    @default(now())
}

enum KBType {
  FILE
  URL
  TEXT
}

enum KBStatus {
  PENDING
  PROCESSING
  READY
  ERROR
}

model KnowledgeBase {
  id            String            @id @default(uuid())
  name          String
  type          KBType            @default(TEXT) // FILE, URL, TEXT
  sourceUrl     String?           // S3 URL or Web URL
  status        KBStatus          @default(PENDING) // PENDING, PROCESSING, READY, ERROR
  errorMessage  String?           @db.Text
  
  organization  Organization      @relation(fields: [organizationId], references: [id])
  organizationId String
  
  vectors       KnowledgeVector[]
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
}

enum SubscriptionStatus {
  PENDING_PAYMENT
  ACTIVE
  EXPIRED
  CANCELLED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TransactionType {
  NEW_SUBSCRIPTION
  RENEWAL
  UPGRADE
}

model KnowledgeVector {
  id            String        @id @default(uuid())
  knowledgeBase KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  knowledgeBaseId String
  
  weaviateId    String        // ID in Weaviate
  content       String        @db.Text
  metadata      Json?         // Page number, source, etc.
  
  createdAt     DateTime      @default(now())
}

// Super Admin - Global LLM Providers
model LLMProvider {
  id            String   @id @default(uuid())
  name          String   // OpenAI, Gemini, Anthropic
  apiKey        String   // Encrypted
  baseUrl       String?
  models        String // Comma separated
  defaultModel  String?
  isActive      Boolean  @default(true)
  priority      Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model LLMUsageLog {
  id            String   @id @default(uuid())
  providerId    String
  model         String
  tokensInput   Int
  tokensOutput  Int
  cost          Float
  organizationId String?
  agentId       String?
  createdAt     DateTime @default(now())
}

model Agenda {
  id            String   @id @default(uuid())
  subject       String
  client        String?
  date          DateTime
  summary       String?  @db.Text
  
  organization  Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  
  contact       Contact? @relation(fields: [contactId], references: [id])
  contactId     String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime     @updatedAt
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Playground Tables - Isolated from production
model PlaygroundAgent {
  id             String              @id @default(uuid())
  name           String
  description    String?             @db.Text
  prompt         String              @db.Text
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions       PlaygroundSession[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

model PlaygroundSession {
  id             String              @id @default(uuid())
  agentId        String
  agent          PlaygroundAgent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status         String              @default("DISCONNECTED") // DISCONNECTED, QR_READY, AUTHENTICATED, CONNECTED
  qrCode         String?             @db.LongText
  messages       PlaygroundMessage[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
}

model PlaygroundMessage {
  id        String            @id @default(uuid())
  sessionId String
  session   PlaygroundSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  content   String            @db.Text
  sender    String            // 'user' or 'agent'
  createdAt DateTime          @default(now())
}

// ============================================
// E-COMMERCE MODELS (Products & Orders)
// ============================================

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PROCESSING
  SHIPPED
  COMPLETED
  REJECTED
}

model Product {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  
  name           String
  description    String       @db.Text
  price          Decimal      @db.Decimal(10, 2)
  imageUrl       String?
  category       String?
  
  isPhysical     Boolean      @default(true)
  stock          Int?         // Only used if isPhysical = true
  isActive       Boolean      @default(true)
  
  orderItems     OrderItem[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

model Order {
  id                String      @id @default(uuid())
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId    String
  contact           Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId         String
  
  status            OrderStatus @default(PENDING)
  rejectionReason   String?     @db.Text
  
  totalAmount       Decimal     @db.Decimal(10, 2)
  deliveryAddress   String      @db.Text
  paymentProofUrl   String?
  
  items             OrderItem[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([organizationId])
  @@index([contactId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                  String   @id @default(uuid())
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId             String
  product             Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId           String
  
  quantity            Int
  priceAtTime         Decimal  @db.Decimal(10, 2)
  productNameSnapshot String
  
  @@index([orderId])
  @@index([productId])
}
